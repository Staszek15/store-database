---
title: "Gamestalgia - raport"
author: 
- Wiktoria Fimińska 262283, Julia Grzegorzewska 262314, 
- Karolina Wypych 262333, Mateusz Stasiak 262339
date: "`r Sys.Date()`"
fontsize: 12pt
output: 
  pdf_document:
    number_sections: true
    toc: true
    fig_caption: true
toc-title : "Spis treści"
header-includes:
    - \usepackage{graphicx}
    - \usepackage{amsmath}
    - \usepackage{multirow}
    - \usepackage{float}
    - \usepackage{enumitem}
    - \usepackage{mathtools}
    - \usepackage{hyperref}
    - \usepackage{url}
    - \mathtoolsset{showonlyrefs}
    - \usepackage{caption}
    - \usepackage{geometry}
    
---
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```


\section{Wprowadzenie}
Niniejszy raport jest analizą danych zawartych w bazie sklepu "Gamestalgia". 
\section{Rozkład danych}

```{r}
library('reticulate')
use_python("C:\\Users\\mateu\\AppData\\Local\\Programs\\Python\\Python39")
```

```{python}
import numpy as np
from sqlalchemy import create_engine, inspect, URL, text
import pandas as pd
import pymysql
from tabulate import tabulate
import matplotlib.pyplot as plt
import seaborn as sns
```

```{python}
url_object = URL.create(
  "mysql+pymysql",
  username = "team21",
  password = "te@mzi",
  host = "giniewicz.it",
  database = "team21"
)

engine = create_engine(url_object)
connection = engine.connect()
```

\section{Pracownik miesiąca}
Dla każdego miesiąca działania sklepu wygenerowano tabele z pracownikiem danego miesiąca, na podstawie liczby sprzedanych przez niego gier (tabela \ref{tab:tab1}).

```{python, echo = FALSE, results = 'hide'}
query1 = connection.execute(text('''SELECT date, CONCAT(s.first_name, ' ', s.last_name) AS employee, sales_number
                                FROM (
                                  SELECT DATE_FORMAT(date,'%Y-%m') AS date, staff_id, COUNT(purchase_id) AS sales_number,
                                         ROW_NUMBER() OVER (PARTITION BY DATE_FORMAT(date,'%Y-%m') ORDER BY COUNT(purchase_id) DESC) AS row_num
                                  FROM purchases
                                  GROUP BY DATE_FORMAT(date,'%Y-%m'), staff_id
                                ) AS subquery
                                LEFT JOIN staff AS s USING(staff_id)
                                WHERE row_num = 1
                                ORDER BY date, sales_number DESC'''))
df1 = pd.DataFrame(query1.fetchall(), columns = query1.keys())

latex_table = tabulate(df1, headers='keys', tablefmt='latex')
caption = 'Pracownicy miesiąca w okresie działalności sklepu.'
label = 'tab:tab1'
latex_table_with_caption_and_label = f"\\begin{{table}}[h]\n\\centering\n\\caption{{{caption}}}\\label{{{label}}}\n{latex_table}\\end{{table}}"

with open('df1.tex', 'w') as f:
    f.write(latex_table_with_caption_and_label)
f.close()

#NIE WIDAC LEGENDY I XTICKS DO POPRAWY, NWM CZY LEPIEJ TABELA CZY WYKRES
sns.set(rc={'figure.figsize':(12,7)})
ax = sns.barplot(x='date', y='sales_number', data=df1, hue='employee', dodge=False)
#plt.title("football players with 80+ rating")
#plt.ylabel("overall rating")
plt.legend(bbox_to_anchor=(1.05, 1), loc='upper left', borderaxespad=0)
plt.xticks(rotation=45)
#plt.bar(df1['date'], df1['sales_number'])
plt.tight_layout()
plt.show()
```

\begin{center}
\input{df1.tex}
\end{center}

```{python}
query11 = connection.execute(text('''WITH tab AS (
                              SELECT date, CONCAT(s.first_name, ' ', s.last_name) AS employee, sales_number
                            FROM (
                              SELECT DATE_FORMAT(date,'%Y-%m') AS date, staff_id, COUNT(purchase_id) AS sales_number,
                                     ROW_NUMBER() OVER (PARTITION BY DATE_FORMAT(date,'%Y-%m') ORDER BY COUNT(purchase_id) DESC) AS row_num
                              FROM purchases
                              GROUP BY DATE_FORMAT(date,'%Y-%m'), staff_id
                            ) AS subquery
                            LEFT JOIN staff AS s USING(staff_id)
                            WHERE row_num = 1
                            ORDER BY date, sales_number DESC
                            )
                            
                            SELECT employee, COUNT(*) AS how_often
                            FROM tab
                            GROUP BY employee
                            ORDER BY COUNT(*) DESC
                            LIMIT 1'''))
df11 = pd.DataFrame(query11.fetchall(), columns=query11.keys())
best_employee = df11['employee'][0]
how_often = df11['how_often'][0]
```


Pracownikiem, który został w tym okresie najczęściej wyróżniony jest `r py$best_employee` , który tytuł ten otrzymał łącznie `r py$how_often` razy. 



\section{Top 10 zawodników}
Ranking zawodników został wyznaczony dla każdej gry turniejowej na podstawie sumy zdobytych przez zawodnika punktów. (tabela \ref{tab:tab2}) Przyznawane one były w zależności od ilości uczestników w danym turnieju według schematu, że pierwsze miejsce otrzymuje liczbę punktów równą liczbie wszystkich uczestników pomniejszoną o jeden, a każde kolejne miejsce o jeden punkt mniej. 

```{python, echo = FALSE}
"""query2 = connection.execute(text('''SELECT g.name AS game, CONCAT(c.first_name, ' ', c.last_name) AS player, score
FROM (
  SELECT t.game_id, customer_id, SUM(score) AS score,
        ROW_NUMBER() OVER (PARTITION BY game_id ORDER BY SUM(score) DESC) AS row_num
        FROM tournament_results AS results
        LEFT JOIN tournament AS t USING(tournament_id)
        GROUP BY game_id, customer_id
) AS subquery
LEFT JOIN customers AS c USING(customer_id)
LEFT JOIN games AS g USING(game_id)
WHERE row_num IN (1,2,3,4,5,6,7,8,9,10)
ORDER BY game_id, score DESC'''))
df2 = pd.DataFrame(query2.fetchall(), columns = query2.keys())

latex_table = tabulate(df2, headers='keys', tablefmt='latex')
caption = 'Ranking top 10 zawodników dla każdej gry turniejowej.'
label = 'tab:tab2'
latex_table_with_caption_and_label = f"\\begin{{table}}[h]\n\\centering\n\\caption{{{caption}}}\\label{{{label}}}\n{latex_table}\\end{{table}}"

with open('df2.tex', 'w') as f:
    f.write(latex_table_with_caption_and_label)
f.close()"""
```

<!-- #\begin{center} -->
<!-- #\input{df2.tex} -->
<!-- #\end{center} -->

\section{Najbardziej dochodowe gry}
Trzy najbardziej dochodowe gry z wypożyczeń to gry, dla których łączna suma podstawowych opłat oraz kar naliczanych za opóźnienie w oddaniu jest największa.

```{python, echo = FALSE, results = 'hide'}
query3 = connection.execute(text('''SELECT g.name AS game, ROUND(SUM(r.price + r.fine),2) AS rental_income
                                  FROM rentals AS r
                                  LEFT JOIN inventory_rent AS i USING(inventory_id)
                                  LEFT JOIN games AS g ON i.game_id = g.game_id
                                  GROUP BY g.name
                                  ORDER BY rental_income DESC
                                  LIMIT 3'''))
                                  
df3 = pd.DataFrame(query3.fetchall(), columns = query3.keys())

latex_table = tabulate(df3, headers='keys', tablefmt='latex')
caption = 'Najbardziej dochodowe gry z wypożyczeń.'
label = 'tab:tab3'
latex_table_with_caption_and_label = f"\\begin{{table}}[h]\n\\centering\n\\caption{{{caption}}}\\label{{{label}}}\n{latex_table}\\end{{table}}"

with open('df3.tex', 'w') as f:
    f.write(latex_table_with_caption_and_label)
f.close()

first_pl = df3['game'][0]
sec_pl = df3['game'][1]
third_pl = df3['game'][2]
```
Przez cały okres funkcjonowania sklepu największy zysk z wypożyczeń przyniosły gry `r py$first_pl`, `r py$sec_pl` oraz `r py$third_pl` (tabela \ref{tab:tab3}).

\begin{center}
\input{df3.tex}
\end{center}